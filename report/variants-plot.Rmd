---
title: "Variant classification"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
ggplot2::theme_set(ggplot2::theme_minimal())
```

#### Methods

We identified phases of dominance by variant for each country. 
We grouped variants into related sublineages, and identified the most prevalent variant detected each week. 
We used a "mixed" category for weeks with <50% dominance by any variant. 

We sourced weekly variant prevalence data from the European Centre for Disease Prevention and Control (ECDC), available at: https://www.ecdc.europa.eu/en/covid-19/variants-concern. 
Where both GISAID and TESSy data are reported, we used GISAID, except where TESSy data were more complete (see Supplement).

```{r data}
library(here)
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(ggplot2)
library(plotly)
# get data
variants_raw <- read_csv("https://opendata.ecdc.europa.eu/covid19/virusvariant/csv/data.csv",
                         progress = FALSE, show_col_types = FALSE)
variant_names <- c("Other" = "Other",
                   "Unknown" = "UNK",
                   "Other" = "SGTF",
                   "Alpha" = "B.1.1.7",
                   "Alpha" = "B.1.1.7+E484K",
                   "Other" = "B.1.351", # Beta
                   "Other" = "P.1", # Gamma
                   "Other" = "P.3", # Gamma
                   "Delta" = "B.1.617.1",
                   "Delta" = "B.1.617.2",
                   "Delta" = "B.1.617.3",
                   "Delta" = "AY.4.2",
                   "Other" = "B.1.427", # Epsilon
                   "Other" = "B.1.429", # Epsilon
                   "Other" = "B.1.427/B.1.429",
                   "Other" = "B.1.526", # Kappa
                   "Other" = "B.1.525", # Eta
                   "Other" = "C.37", # Lambda
                   "Other" = "B.1.620",
                   "Other" = "B.1.621", # Mu
                   "Omicron/BA.1" = "B.1.1.529", # Omicron
                   "Omicron/BA.1" = "BA.1",
                   "Omicron-BA.2" = "BA.2",
                   "Omicron-BA.2" = "BA.2+L452X",  
                   "Omicron-BA.2" = "BA.2.75", 
                   "Omicron-BA.2" = "BA.2.86",
                   "Other" = "BA.3",
                   "Omicron-BA.4/5" = "BA.4/BA.5",
                   "Omicron-BA.4/5" = "BA.4",
                   "Omicron-BA.4/5" = "BA.5",
                   "Omicron-BQ/XBB" = "BQ.1",
                   "Omicron-BQ/XBB" = "XBB",
                   "Omicron-BQ/XBB" = "XBB.1.5-like",
                   "Omicron-BQ/XBB" = "XBB.1.5-like+F456L")

# complete grid of dates and locations in ecdc year-weeks
  date_location <- tibble(
    daily_date = seq.Date(from = as.Date("2020-01-04"), to = Sys.Date(), by = 7),
    year = isoyear(daily_date),
    week = isoweek(daily_date)) |>
    group_by(year, week) |>
    filter(daily_date == min(daily_date)) |>
    filter(between(daily_date,
                   as.Date("2021-03-01"), as.Date("2023-03-17"))) |>
    expand_grid(country = unique(variants_raw$country))

# filter variant data to relevant dates and variants
  variants <- variants_raw |>
    # set dates as a complete grid of location-weeks
    mutate(year = as.numeric(substr(year_week, 1, 4)),
           week = as.numeric(substr(year_week, 6, 8))) |>
    left_join(date_location, by = c("year", "week", "country")) |>
    filter(!is.na(daily_date)) |>
    select(country, year_week, daily_date, source, 
           number_sequenced, variant, percent_variant) |>
    # group variants into named categories
    mutate(variant_name = forcats::fct_recode(variant, !!!variant_names)) |>
    # remove "unknown" as counted in Other
    filter(!variant %in% c("UNK")) |>
    # sum variants by week
    group_by(country, year_week, daily_date, 
             source, number_sequenced, variant_name) |>
    summarise(percent_variant = sum(percent_variant),
              .groups = "drop")
```


```{r dominant-variant}
# identify dominant variant in each week
dominant_2 <- variants |> 
  group_by(country, year_week, daily_date, source, number_sequenced) |>
  slice_max(order_by = percent_variant, with_ties = FALSE, n = 2) |>
  mutate(variant_name = as.character(variant_name),
         rank = row_number()) |>
  ungroup() |> 
  pivot_wider(names_from = source,
              values_from = c(number_sequenced, 
                              variant_name, percent_variant),
              names_glue = "{source}_{.value}",
              values_fill = NA, id_cols = c(country, year_week, daily_date, rank)) 

# find single dominant variant
dominant <- dominant_2 |> 
    # clean and match between GISAID and TESSy
    mutate(dominant_variant = case_when(
      # prefer GISAID if same or TESSY is missing
      GISAID_variant_name == TESSy_variant_name ~ 
        paste("GISAID", GISAID_variant_name),
      is.na(TESSy_variant_name) ~
        paste("GISAID", GISAID_variant_name),
      # prefer GISAID unless "Other", then TESSy
      GISAID_variant_name %in% c("Other") ~
        paste("TESSy", TESSy_variant_name),
      !is.na(GISAID_variant_name) ~ 
        paste("GISAID", GISAID_variant_name),
      TRUE ~ NA_character_))

# (1) Prefer GISAID for known reliability: For the first choice, prefer the GISAID first-ranked variant. 
# (2) Avoiding "Other" category: If GISAID is "Other" and TESSy has a named variant, take TESSy. If the second-ranked variant is the same as the week before, and the first-ranked variant is "Other", take the second-ranked variant. 
# (3) Temporal consistency: If the first-ranked variant is different to the week after and the week before, and the second-ranked variant appears in any source in both the week after and the week before, take the second-ranked variant from that source. 
# Apply these rules in order and add a new column noting the rule applied.
# Add new columns with: dominant variant name, dominant variant percentage, number sequenced, source, rule used to identify dominant variant.

# add dominant % and separate source and name
dominant <- dominant |>
  mutate(dominant_percent = case_when(
             dominant_variant %in% paste("GISAID", GISAID_variant_name) ~ 
               GISAID_percent_variant,
             dominant_variant %in% paste("TESSy", TESSy_variant_name) ~ 
               TESSy_percent_variant,
             TRUE ~ NA_real_)) |> 
      separate(dominant_variant, into = c("source", "dominant_name"), sep = " ")
```


```{r variant-phases}
# identify start and end dates of variant phases
dominant_phases <- dominant |>
   arrange(country, daily_date) |>
   group_by(country) |>
   mutate(phase_change = dominant_name != lag(dominant_name, 
                                              default = first(dominant_name)),
          phase_id = 1 + cumsum(phase_change)) |>
   group_by(country, phase_id, dominant_name) |>
   summarise(start_date = min(daily_date),
             end_date = max(daily_date),
             .groups = "drop")
```

Dominant variant (most prevalent in a given week) by country over time:

```{r plot-dominant-selection, fig.width=10, fig.height=36}
plot_dominant <- dominant |> 
  ggplot(aes(x = daily_date,
             y = dominant_percent,
             fill = dominant_name)) +
  geom_col() +
  labs(x = NULL, y = "% dominant variant", 
       fill = "Dominant variant", col = NULL) +
  scale_fill_viridis_d() +
  theme(legend.position = "bottom") +
  facet_wrap(~country, ncol = 1)

plot_dominant |> 
  ggplotly()
```


We identified single start and end dates for each phases of variant dominance.

```{r plot-variant-phase}
# plot variant phases
plot_phases <- dominant_phases |>
  ggplot(aes(x = start_date,
             y = country,
             col = dominant_name)) +
  geom_pointrange(aes(xmin = start_date, xmax = end_date)) +
  scale_color_viridis_d() +
  labs(x = NULL, y = NULL, col = "Dominant phase") +
  theme(legend.position = "bottom")

plot_phases |> 
  ggplotly()
```
### Manual adjustment

Where countries had < 4 or > 5 phases, we manually checked to maintain consistency across countries and avoid rapid switching between variants where this may have been due to sampling biases.

```{r manual-adjustment}
# manual adjustments to variant phases based on visual inspection
plot_phases_anomaly <- dominant |>
  group_by()
  ggplot(aes(x = start_date,
             y = country,
             col = dominant_name)) +
  geom_pointrange(aes(xmin = start_date, xmax = end_date)) +
  scale_color_viridis_d() +
  labs(x = NULL, y = NULL, col = "Dominant phase") +
  theme(legend.position = "bottom")

plot_phases_anomaly |> 
  ggplotly()
```

### Supplement

#### All variants by data source

```{r plot, fig.width=10, fig.height=32}
plot_all <- variants |>
    ggplot(aes(x = daily_date,
               y = percent_variant,
               fill = variant_name)) +
    geom_col(position = position_stack()) +
    labs(x = NULL, y = "% variant", 
         fill = NULL, col = NULL, fill = NULL) +
    scale_fill_viridis_d() +
    scale_color_viridis_d() +
    facet_grid(rows = vars(country), cols = vars(source)) +
    theme(legend.position = "bottom")
ggplotly(plot_all)
```
