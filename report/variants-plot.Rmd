---
title: "Variant classification"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
ggplot2::theme_set(ggplot2::theme_minimal())
```

#### Methods

To identify phases of variant dominance for each country, we sourced weekly variant prevalence data from the European Centre for Disease Prevention and Control (ECDC), available at: https://www.ecdc.europa.eu/en/covid-19/variants-concern. 

```{r data}
library(here)
library(dplyr)
library(tidyr)
library(readr)
library(forcats)
library(lubridate)
library(ggplot2)
library(plotly)
# get data
geocodes <- read_delim("https://raw.githubusercontent.com/omnika-datastore/unsd-m49-standard-area-codes/refs/heads/main/2022-09-24__CSV_UNSD_M49.csv", delim = ";") |> 
  select(eu_region = `Sub-region Name`, country_code = `ISO-alpha2 Code`) |> 
  # join Cyprus with S. Europe for consistency
  mutate(eu_region = ifelse(eu_region == "Western Asia", "Southern Europe",
                            eu_region))

variants_raw <- read_csv("https://opendata.ecdc.europa.eu/covid19/virusvariant/csv/data.csv") |>
  mutate(country_code = ifelse(country == "Greece", "GR", country_code)) |>
  left_join(geocodes, by = "country_code") |> 
  mutate(country = fct_reorder(country, eu_region, 
                               .fun = function(x) min(as.numeric(factor(x)))))

variant_names <- c("Other" = "Other",
                   "Unknown" = "UNK",
                   "Other" = "SGTF",
                   "Alpha" = "B.1.1.7",
                   "Alpha" = "B.1.1.7+E484K",
                   "Other" = "B.1.351", # Beta
                   "Other" = "P.1", # Gamma
                   "Other" = "P.3", # Gamma
                   "Delta" = "B.1.617.1",
                   "Delta" = "B.1.617.2",
                   "Delta" = "B.1.617.3",
                   "Delta" = "AY.4.2",
                   "Other" = "B.1.427", # Epsilon
                   "Other" = "B.1.429", # Epsilon
                   "Other" = "B.1.427/B.1.429",
                   "Other" = "B.1.526", # Kappa
                   "Other" = "B.1.525", # Eta
                   "Other" = "C.37", # Lambda
                   "Other" = "B.1.620",
                   "Other" = "B.1.621", # Mu
                   "Omicron-BA.1" = "B.1.1.529", # Omicron
                   "Omicron-BA.1" = "BA.1",
                   "Omicron-BA.2" = "BA.2",
                   "Omicron-BA.2" = "BA.2+L452X",  
                   "Omicron-BA.2" = "BA.2.75", 
                   "Omicron-BA.2" = "BA.2.86",
                   "Other" = "BA.3",
                   "Omicron-BA.4/5" = "BA.4/BA.5",
                   "Omicron-BA.4/5" = "BA.4",
                   "Omicron-BA.4/5" = "BA.5",
                   "Omicron-BQ/XBB" = "BQ.1",
                   "Omicron-BQ/XBB" = "XBB",
                   "Omicron-BQ/XBB" = "XBB.1.5-like",
                   "Omicron-BQ/XBB" = "XBB.1.5-like+F456L")

# complete grid of dates and locations in ecdc year-weeks
  date_location <- tibble(
    daily_date = seq.Date(from = as.Date("2020-01-04"), to = Sys.Date(), by = 7),
    year = isoyear(daily_date),
    week = isoweek(daily_date)) |>
    group_by(year, week) |>
    filter(daily_date == min(daily_date)) |>
    filter(between(daily_date,
                   as.Date("2021-03-01"), as.Date("2023-03-17"))) |>
    expand_grid(country = unique(variants_raw$country))

# filter variant data to relevant dates and variants
  variants <- variants_raw |>
    # remove variant identification when number sequenced <3
    mutate(across(c(variant, percent_variant),
                ~ if_else(number_sequenced < 3, NA, .x))) |> 
    # set dates as a complete grid of location-weeks
    mutate(year = as.numeric(substr(year_week, 1, 4)),
           week = as.numeric(substr(year_week, 6, 8))) |>
    left_join(date_location, by = c("year", "week", "country")) |>
    filter(!is.na(daily_date)) |>
    select(eu_region, country, year_week, daily_date, source, 
           percent_cases_sequenced, number_sequenced, 
           variant, percent_variant) |>
    # group variants into named categories
    mutate(variant_name = forcats::fct_recode(variant, !!!variant_names)) |>
    # remove "unknown" as counted in Other
    filter(!variant %in% c("UNK")) |>
    # sum variants by week
    group_by(eu_region, country, year_week, daily_date, 
             source, number_sequenced, percent_cases_sequenced,
             variant_name) |>
    summarise(percent_variant = sum(percent_variant),
              .groups = "drop")
```
```{r coverage, fig.height=10, fig.width=10}
variants |> 
  distinct(eu_region, country, daily_date, source, percent_cases_sequenced) |> 
  ggplot(aes(x = daily_date, y = country, fill = log(percent_cases_sequenced))) +
  geom_tile() +
  #scale_fill_viridis_b(breaks = c(0, 1, 5, 10, 15, NA)) +
  facet_grid(rows = vars(eu_region), cols = vars(source), scales = "free") +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = NULL, fill = "Log % cases sequenced", 
       subtitle = "Variant sequencing coverage by source")
```
```{r all-variants, fig.width=10, fig.height=32}
plot_all <- variants |>
    ggplot(aes(x = daily_date,
               y = percent_variant,
               fill = variant_name)) +
    geom_col(position = position_stack()) +
    labs(x = NULL, y = "% variant", 
         fill = NULL, col = NULL, fill = NULL) +
    scale_fill_viridis_d() +
    scale_color_viridis_d() +
    facet_grid(rows = vars(country), cols = vars(source)) +
    theme(legend.position = "bottom")
plot_all
```

We grouped variants into related sublineages, and identified the most prevalent variant detected each week. 
Where both GISAID and TESSy data are reported, we used GISAID, except where TESSy data were more complete.

```{r dominant-variant}
# identify dominant variant in each week by source
dominant <- variants |> 
  group_by(eu_region, country, year_week, daily_date, 
           source, number_sequenced) |>
  slice_max(order_by = percent_variant, with_ties = FALSE, n = 1) |>
  mutate(variant_name = as.character(variant_name)) |>
  ungroup() |> 
  # widen to have GISAID and TESSy side-by-side
  pivot_wider(names_from = source,
              values_from = c(number_sequenced, 
                              variant_name, percent_variant),
              names_glue = "{source}_{.value}",
              values_fill = NA, id_cols = c(eu_region, country, 
                                            year_week, daily_date)) 

# find single dominant variant
# (1) Prefer GISAID for known reliability: For the first choice, prefer the GISAID first-ranked variant. 
# (2) Avoiding "Other"/NA category: If GISAID is "Other"/NA and TESSy has a named variant, take TESSy
dominant <- dominant |> 
    # clean and match between GISAID and TESSy
    mutate(dominant_variant = case_when(
      # prefer GISAID if TESSy missing
      is.na(TESSy_variant_name) ~
        paste("GISAID", GISAID_variant_name),
      # prefer TESSy if GISAID is missing or "Other"
      GISAID_variant_name %in% c("Other", NA) ~
        paste("TESSy", TESSy_variant_name),
      TRUE ~ paste("GISAID", GISAID_variant_name)))

# add dominant % and separate source and name
dominant <- dominant |>
  mutate(dominant_percent = case_when(
             dominant_variant %in% paste("GISAID", GISAID_variant_name) ~ 
               GISAID_percent_variant,
             dominant_variant %in% paste("TESSy", TESSy_variant_name) ~ 
               TESSy_percent_variant,
             TRUE ~ NA_real_)) |> 
  separate(dominant_variant, 
           into = c("source", "dominant_name"), sep = " ") |> 
  mutate(dominant_name = na_if(dominant_name, "NA"))
```
```{r plot-dominant-selection, fig.width=10, fig.height=15}
plot_dominant <- dominant |> 
  ggplot(aes(x = daily_date,
             y = country,
             fill = dominant_name)) +
  geom_tile() +
  labs(x = NULL, y = NULL, fill = "Dominant variant", col = NULL, 
       subtitle = "Dominant variant (most prevalent in a given week) by country over time") +
  scale_fill_viridis_d() +
  theme(legend.position = "bottom") +
  facet_wrap(~eu_region, ncol = 1, scales = "free")

plot_dominant
```

We identified sequential variant phases from the first week that a variant became dominant. 
We treated weeks dominated by an unknown variant as missing, and replaced all weeks with missing data with the most recently identified dominant variant.

```{r variant-phases}
# identify start dates of variant phases
dominant_phases <- dominant |>
  mutate(dominant_name = ifelse(dominant_name == "Other", NA, dominant_name)) |>
  filter(!is.na(dominant_name)) |>
  group_by(eu_region, country) |>
  arrange(daily_date) |>
  group_by(dominant_name, .add = TRUE) |>
  summarise(daily_date = first(daily_date), .groups = "drop") |> 
  right_join(date_location, 
            by = c("country", "daily_date")) |> 
  group_by(country) |>
  arrange(daily_date) |> 
  fill(eu_region, dominant_name, .direction = "downup")
```
```{r plot-variant-phases, fig.width=10, fig.height=15}
plot_phases <- dominant_phases |>            
  ggplot(aes(x = daily_date,
             y = country,
             fill = dominant_name)) +
  geom_tile() +
  labs(x = NULL, y = NULL, fill = "Dominant variant phase", col = NULL,
       subtitle = "Sequential phases of dominant variants") +
  scale_fill_viridis_d() +
  facet_wrap(~eu_region, ncol = 1, scales = "free", drop = TRUE) +
  theme(legend.position = "bottom")

plot_phases
```
